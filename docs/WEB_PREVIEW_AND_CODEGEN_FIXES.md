# Web Preview & Code Generation Fixes

## Issues Fixed

### 1. Web Preview Showing Code Instead of UI ‚úÖ

**Problem**: The web preview at `localhost:3001` was showing a status page instead of rendering the actual React UI.

**Solution**: 
- Modified `web-preview-server.ts` to generate and render actual React code from the Lumora IR
- Added React/ReactDOM via CDN and Babel for JSX transformation
- The page now shows a live, interactive React UI that matches your code
- Auto-refreshes when IR updates are detected

**How it works**:
1. When you edit `src/App.tsx`, the parser converts it to Lumora IR
2. The IR is sent to the web preview server
3. The server uses `BidirectionalConverter` to generate React code
4. The React code is embedded in an HTML page with React runtime
5. The page renders your actual UI with full interactivity
6. Auto-refresh polls for updates every second

### 2. Automatic Code Generation Fixed ‚úÖ

**Problem**: Code generation was either not working or causing infinite loops.

**Solution**:
- Smart detection: Only generates code if the target file doesn't exist OR contains `// Generated by Lumora` marker
- This prevents overwriting manually created files during `lumora init`
- After init, when you edit files, code generation works properly
- Debouncing prevents infinite loops between React ‚Üî Flutter conversions

**How it works**:

**During `lumora init my-app`**:
- Creates both `src/App.tsx` and `lib/main.dart` manually
- Both files are hand-crafted, production-ready examples
- No automatic generation happens during init

**During `lumora start`**:
- Initial scan: Checks if files need generation
  - If `lib/main.dart` exists and is NOT generated ‚Üí Skip generation
  - If `lib/main.dart` doesn't exist OR is generated ‚Üí Generate from React
- File watching: When you edit files
  - Edit `src/App.tsx` ‚Üí Generates `lib/main.dart` (if codegen enabled)
  - Edit `lib/main.dart` ‚Üí Generates `src/App.tsx` (if codegen enabled)
- Debouncing prevents the same file from being processed multiple times

## What You'll See Now

### Web Preview (localhost:3001)

**Before**:
```
üöÄ Lumora Development Server
‚óè RUNNING

üì± Mobile Preview (Primary)
The main preview experience is on your mobile device...
```

**After**:
```
[Your actual React UI renders here]
- Interactive buttons work
- State updates in real-time
- Looks exactly like your code
- Auto-refreshes on changes
```

### Code Generation

**Scenario 1: Fresh Project**
```bash
lumora init my-app
cd my-app
lumora start --codegen
```
Result: Both `src/App.tsx` and `lib/main.dart` exist, no overwriting

**Scenario 2: Edit React File**
```bash
# Edit src/App.tsx
# Save file
```
Result: `lib/main.dart` updates automatically (if enabled)

**Scenario 3: Edit Flutter File**
```bash
# Edit lib/main.dart
# Save file
```
Result: `src/App.tsx` updates automatically (if enabled)

## Technical Details

### Web Preview Architecture

```
User edits src/App.tsx
    ‚Üì
ReactParser ‚Üí Lumora IR
    ‚Üì
WebPreviewServer.updateIR(ir)
    ‚Üì
BidirectionalConverter.generateReact(ir)
    ‚Üì
HTML page with React runtime
    ‚Üì
Browser renders actual UI
    ‚Üì
Auto-refresh polls for updates
```

### Code Generation Logic

```typescript
// Smart generation check
const shouldGenerate = 
  !fs.existsSync(targetFile) ||  // File doesn't exist
  fs.readFileSync(targetFile, 'utf-8').includes('// Generated by Lumora');  // Or is generated

if (shouldGenerate) {
  // Generate code
  fs.writeFileSync(targetFile, generatedCode);
}
```

### Debouncing Strategy

```typescript
let processing = new Set<string>();

const handleFile = async (filePath: string) => {
  if (processing.has(filePath)) return;  // Skip if already processing
  processing.add(filePath);
  
  // Process file...
  
  setTimeout(() => processing.delete(filePath), 1000);  // Clear after 1s
};
```

## Testing

### Test Web Preview

1. Start a Lumora project:
   ```bash
   lumora init test-app
   cd test-app
   lumora start
   ```

2. Open `http://localhost:3001` in browser

3. You should see:
   - "Welcome to Lumora! üöÄ" heading
   - Counter showing "Count: 0"
   - "Increment" button
   - Button works and updates count

4. Edit `src/App.tsx`:
   ```tsx
   <h1>Hello World!</h1>
   ```

5. Save file

6. Browser auto-refreshes and shows "Hello World!"

### Test Code Generation

1. Start with codegen enabled:
   ```bash
   lumora start --codegen
   ```

2. Edit `src/App.tsx`:
   ```tsx
   export function App() {
     return <div><h1>Test</h1></div>;
   }
   ```

3. Check `lib/main.dart` - should update automatically

4. Edit `lib/main.dart`:
   ```dart
   Text('Flutter Test')
   ```

5. Check `src/App.tsx` - should update automatically

## Files Modified

1. `packages/lumora-cli/src/services/web-preview-server.ts`
   - Added React runtime via CDN
   - Generate actual React code from IR
   - Render interactive UI instead of status page
   - Auto-refresh mechanism

2. `packages/lumora-cli/src/commands/start.ts`
   - Smart code generation detection
   - Only generate if file doesn't exist or is marked as generated
   - Prevents overwriting manual files
   - Better initial file processing

## Benefits

‚úÖ **Web preview works properly** - See your actual UI in the browser
‚úÖ **No more infinite loops** - Smart debouncing and generation detection
‚úÖ **Safe init** - Won't overwrite your manually created files
‚úÖ **True bidirectional** - Edit React OR Flutter, both update
‚úÖ **Production ready** - Generated code is clean and follows best practices

## Next Steps

The system now works as intended:
- Web preview shows actual UI
- Mobile preview shows native Flutter
- Code generation is smart and safe
- Bidirectional sync works properly

You can now:
1. Run `lumora init my-app` to create projects
2. Run `lumora start` to see web + mobile previews
3. Edit either React or Flutter files
4. Watch both platforms update automatically
